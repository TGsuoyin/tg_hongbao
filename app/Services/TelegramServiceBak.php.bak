<?php

namespace App\Services;

use App\Jobs\LuckyHistoryJob;
use App\Jobs\MsgToTelegram;
use App\Models\AuthGroup;
use App\Models\InviteLink;
use App\Models\JackpotPool;
use App\Models\JackpotReward;
use App\Models\LuckyHistory;
use App\Models\LuckyMoney;
use App\Models\RechargeRecord;
use App\Models\TgUser;
use App\Models\WithdrawRecord;
use App\Telegram\Middleware\GroupVerify;
use Dcat\Admin\Admin;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Log;
use Illuminate\Support\Facades\Redis;
use SergiX44\Nutgram\Nutgram;
use SergiX44\Nutgram\RunningMode\Polling;
use SergiX44\Nutgram\Telegram\Attributes\ParseMode;
use SergiX44\Nutgram\Telegram\Exceptions\TelegramException;
use SergiX44\Nutgram\Telegram\Types\Keyboard\InlineKeyboardButton;
use SergiX44\Nutgram\Telegram\Types\Keyboard\InlineKeyboardMarkup;

/**
 * author [@cody](https://t.me/cody0512)
 */
class TelegramService
{

    public static function handleRed(Nutgram $bot)
    {

        $bot->group(GroupVerify::class, function (Nutgram $bot) {

            // Your handlers here
            // Called when a message contains the command "/start someParameter"
//            $bot->onCommand('start {parameter}', function (Nutgram $bot, $parameter) {
//                $bot->sendMessage("The parameter is {$parameter}");
//            });
            // ex. called when a message contains "My name is Mario"
            $bot->onText('ä¸Šåˆ†([0-9]+)', function (Nutgram $bot, $amount) {
                $from = $bot->message()->from->id;
                $finance = ConfigService::getConfigValue($bot->chat()->id, 'finance');
                $financeArr = explode(',', $finance);
                if (!in_array($from, $financeArr)) {
                    return false;
                }
                $params = ['parse_mode' => ParseMode::HTML, 'reply_to_message_id' => $bot->message()->message_id];
                if ($amount < 1 || !$amount) {
                    $bot->sendMessage("ä¸Šåˆ†é‡‘é¢é”™è¯¯", $params);
                    return false;
                }
                $reply_to_message = $bot->message()->reply_to_message;
                if (!$reply_to_message) {
                    return false;
                }
                if ($reply_to_message->from->is_bot == true) {
                    return false;
                }
                $username = $reply_to_message->from->first_name != '' ? $reply_to_message->from->first_name : $reply_to_message->from->username;
                $tgId = $reply_to_message->from->id;
                $user = TgUser::query()->where('tg_id', $tgId)->where('group_id', $bot->chat()->id)->first();
                if (!$user) {
                    TgUserService::registerUser($reply_to_message->from, $bot->chat()->id);
                    $user = TgUser::query()->where('tg_id', $tgId)->where('group_id', $bot->chat()->id)->first();
                }
                $balance = $user->balance + $amount;
                try {
                    DB::beginTransaction();
                    $user->balance = $balance;
                    $rs = $user->save();
                    if ($rs) {
                        money_log($user->group_id, $user->tg_id, $amount, 'recharge', 'è´¢åŠ¡ä¸Šåˆ†');
                        $insert = [
                            'tg_id' => $user->tg_id,
                            'username' => $user->username,
                            'first_name' => $user->first_name,
                            'group_id' => $user->group_id,
                            'amount' => $amount,
                            'remark' => 'è´¢åŠ¡ä¸Šåˆ†',
                            'status' => 1,
                            'type' => 3,//è´¢åŠ¡ç¾¤èŠä¸Šåˆ†
                            'admin_id' => 0,
                        ];
                        $rs2 = RechargeRecord::query()->create($insert);
                        if (!$rs2) {
                            DB::rollBack();
                            $bot->sendMessage("ä¸Šåˆ†å¤±è´¥ï¼Œè¯·è”ç³»ç®¡ç†å‘˜", $params);
                            return false;
                        }
                        DB::commit();
                        $bot->sendMessage("âœ… ä¸Šåˆ† <b>{$amount}</b> æˆåŠŸ
ğŸ”¹æ‚¨çš„ç”¨æˆ·: <code>{$username}</code>
ğŸ”¹æ‚¨çš„ç”¨æˆ·ID: <code>{$tgId}</code>
ğŸ”¹ä½™é¢: <b>{$balance}</b> U", $params);
                    }
                } catch (\Exception $e) {
                    Log::error('ä¸Šåˆ†å¼‚å¸¸:' . $e->getMessage() . ' code=>' . $e->getCode());
                    $bot->sendMessage("ä¸Šåˆ†å¤±è´¥ï¼Œè¯·è”ç³»ç®¡ç†å‘˜", $params);
                }
            });
            $bot->onText('ä¸‹åˆ†([0-9]+)', function (Nutgram $bot, $amount) {
                $from = $bot->message()->from->id;
                $finance = ConfigService::getConfigValue($bot->chat()->id, 'finance');
                $financeArr = explode(',', $finance);
                if (!in_array($from, $financeArr)) {
                    return false;
                }
                $params = ['parse_mode' => ParseMode::HTML, 'reply_to_message_id' => $bot->message()->message_id];
                if ($amount < 1 || !$amount) {
                    $bot->sendMessage("ä¸‹åˆ†é‡‘é¢é”™è¯¯", $params);
                    return false;
                }
                $reply_to_message = $bot->message()->reply_to_message;
                if (!$reply_to_message) {
                    return false;
                }
                if ($reply_to_message->from->is_bot == true) {
                    return false;
                }
                $username = $reply_to_message->from->first_name != '' ? $reply_to_message->from->first_name : $reply_to_message->from->username;
                $tgId = $reply_to_message->from->id;
                $user = TgUser::query()->where('tg_id', $tgId)->where('group_id', $bot->chat()->id)->first();
                if (!$user || $amount > $user->balance) {
                    $bot->sendMessage("ç”¨æˆ·ä½™é¢ä¸è¶³", $params);
                    return false;
                }
                $balance = $user->balance - $amount;
                try {
                    DB::beginTransaction();
                    $user->balance = $balance;
                    $rs = $user->save();
                    if ($rs) {
                        money_log($user->group_id, $user->tg_id, -$amount, 'withdraw', 'è´¢åŠ¡ä¸‹åˆ†');
                        $insert = [
                            'tg_id' => $user->tg_id,
                            'username' => $user->username,
                            'first_name' => $user->first_name,
                            'group_id' => $user->group_id,
                            'amount' => $amount,
                            'remark' => 'è´¢åŠ¡ä¸‹åˆ†',
                            'status' => 1,
                            'address' => '',
                            'addr_type' => '',
                            'admin_id' => 0,
                        ];
                        $rs2 = WithdrawRecord::query()->create($insert);
                        if (!$rs2) {
                            DB::rollBack();
                            $bot->sendMessage("ä¸‹åˆ†å¤±è´¥ï¼Œè¯·è”ç³»ç®¡ç†å‘˜", $params);
                            return false;
                        }
                        DB::commit();
                        $bot->sendMessage("âœ… ä¸‹åˆ† <b>{$amount}</b> æˆåŠŸ
ğŸ”¹æ‚¨çš„ç”¨æˆ·:  <code>{$username}</code>
ğŸ”¹æ‚¨çš„ç”¨æˆ·ID: <code>{$tgId}</code>
ğŸ”¹ä½™é¢: <b>{$balance}</b> U", $params);
                    }
                } catch (\Exception $e) {
                    Log::error('ä¸‹åˆ†å¼‚å¸¸:' . $e->getMessage() . ' code=>' . $e->getCode());
                    $bot->sendMessage("ä¸‹åˆ†å¤±è´¥ï¼Œè¯·è”ç³»ç®¡ç†å‘˜", $params);
                }
            });
            $bot->onText('(å‘[åŒ…]*)*([0-9]+\.?[0-9]?)[-/]([0-9]+\.?[0-9]?)', function (Nutgram $bot, $ac, $amount, $mine) {
                $pattern = '/^\d+\.\d+?$/';
                if (preg_match($pattern, $amount)) {
                    try {
                        $bot->sendMessage('æŒ‡ä»¤æœ‰è¯¯ï¼Œè¯·è¾“å…¥æ•´æ•°', ['reply_to_message_id' => $bot->message()->message_id]);
                    } catch (\Exception $e) {
                        $bot->sendMessage('æŒ‡ä»¤æœ‰è¯¯ï¼Œè¯·è¾“å…¥æ•´æ•°');
                    }
                    return false;
                }
                if (preg_match($pattern, $mine)) {
                    try {
                        $bot->sendMessage('æŒ‡ä»¤æœ‰è¯¯ï¼Œè¯·è¾“å…¥æ•´æ•°', ['reply_to_message_id' => $bot->message()->message_id]);
                    } catch (\Exception $e) {
                        $bot->sendMessage('æŒ‡ä»¤æœ‰è¯¯ï¼Œè¯·è¾“å…¥æ•´æ•°');
                    }
                    return false;
                }
                if ($mine > 9 || $mine < 0 || $mine == null) {
                    try {
                        $bot->sendMessage('æŒ‡ä»¤æœ‰è¯¯ï¼Œé›·æ•°åº”æ˜¯0~9ä¹‹é—´', ['reply_to_message_id' => $bot->message()->message_id]);
                    } catch (\Exception $e) {
                        $bot->sendMessage('æŒ‡ä»¤æœ‰è¯¯ï¼Œé›·æ•°åº”æ˜¯0~9ä¹‹é—´');
                    }
                    return false;
                }
                $minAmount = ConfigService::getConfigValue($bot->chat()->id, 'min_amount');
                if ($amount < $minAmount) {
                    try {
                        $bot->sendMessage("çº¢åŒ…é‡‘é¢ä¸èƒ½å°äº {$minAmount} U", ['reply_to_message_id' => $bot->message()->message_id]);
                    } catch (\Exception $e) {
                        $bot->sendMessage("çº¢åŒ…é‡‘é¢ä¸èƒ½å°äº {$minAmount} U");
                    }
                    return false;
                }
                $maxAmount = ConfigService::getConfigValue($bot->chat()->id, 'max_amount');
                if ($amount > $maxAmount) {
                    try {
                        $bot->sendMessage("çº¢åŒ…é‡‘é¢ä¸èƒ½å¤§äº {$maxAmount} U", ['reply_to_message_id' => $bot->message()->message_id]);
                    } catch (\Exception $e) {
                        $bot->sendMessage("çº¢åŒ…é‡‘é¢ä¸èƒ½å¤§äº {$maxAmount} U");
                    }
                    return false;
                }
                $amount = (int)$amount;
                $mine = (int)$mine;
                $sendUserId = $bot->user()->id;
                $senderInfo = TgUser::query()->where('tg_id', $sendUserId)->where('group_id', $bot->chat()->id)->first();
                //æ£€æŸ¥ä½™é¢
                $checkRs = TgUserService::checkBalance($senderInfo, $amount);
                if ($checkRs['state'] != 1) {
                    try {
                        $bot->sendMessage($checkRs['msg'], ['reply_to_message_id' => $bot->message()->message_id]);
                    } catch (\Exception $e) {
                        $bot->sendMessage($checkRs['msg']);
                    }
                } else {
                    $luckyTotal = ConfigService::getConfigValue($bot->chat()->id, 'lucky_num');

                    DB::beginTransaction();
                    //æ·»åŠ çº¢åŒ…
                    $luckyId = LuckyMoneyService::addLucky($senderInfo, $bot->message()->from->first_name, $amount, $mine, $bot->chat()->id, $luckyTotal, 0);
                    if ($luckyId) {
                        $photo = get_photo($bot->chat()->id);
                        if (!$photo) {
                            DB::rollBack();
                            try {
                                $bot->sendMessage('è¯·åœ¨åå°è®¾ç½®å›¾ç‰‡ï¼', ['reply_to_message_id' => $bot->message()->message_id]);
                            } catch (\Exception $e) {
                                $bot->sendMessage("è¯·åœ¨åå°è®¾ç½®å›¾ç‰‡ï¼");
                            }
                            return false;
                        }
                        $num = 3;
                        for ($i = $num; $i >= 0; $i--) {
                            if ($i <= 0) {
                                Log::error('é‡è¯•3æ¬¡ï¼Œå‘é€çº¢åŒ…å¤±è´¥');
                                DB::rollBack();
                                return false;
                            }
                            try {
                                $InlineKeyboardMarkup = InlineKeyboardMarkup::make()->addRow(
                                    InlineKeyboardButton::make("ğŸ§§æŠ¢çº¢åŒ…[{$luckyTotal}/0]æ€»{$amount}U ğŸ’¥é›·{$mine}", callback_data: "qiang-" . $luckyId)
                                );
                                $data = [
                                    'caption' => "[ <code>" . format_name($bot->message()->from->first_name) . "</code> ]å‘äº†ä¸ª {$amount} U çº¢åŒ…ï¼Œå¿«æ¥æŠ¢ï¼",
                                    'parse_mode' => ParseMode::HTML,
                                    'reply_markup' => common_reply_markup($bot->chat()->id, $InlineKeyboardMarkup),
                                    'reply_to_message_id' => $bot->message()->message_id
                                ];
                                $sendRs = $bot->sendPhoto($photo, $data);
                                if ($sendRs) {
                                    $updateRs = LuckyMoney::query()->where('id', $luckyId)->update(['message_id' => $sendRs->message_id]);
                                    if (!$updateRs) {
                                        DB::rollBack();
                                        $bot->sendMessage('å‘é€å¤±è´¥');
                                        return false;
                                    }
                                    DB::commit();
                                    break;
                                } else {
                                    DB::rollBack();
                                    Log::error('sendPhotoå‘é€å¤±è´¥');
                                    $bot->sendMessage('å‘é€å¤±è´¥');
                                }
                            } catch (\Exception $e) {
                                Log::error('çº¢åŒ…å‘é€å¤±è´¥=>code=>' . $e->getCode() . '  msg=>' . $e->getMessage());
                                if ($e->getCode() == 429) {
                                    $retry_after = $e->getParameter('retry_after');
                                    sleep($retry_after);
                                } else {
                                    DB::rollBack();
                                    break;
                                }
                                //throw new TelegramException($e->getMessage(),$e->getCode());
                            }
                        }
                    } else {
                        $bot->sendMessage('å‘é€å¤±è´¥');
                    }


                }


            });
            $bot->onText('ç¦åˆ©([0-9]+\.?[0-9]?)[-/]([0-9]+\.?[0-9]?)', function (Nutgram $bot, $amount, $num) {
                $pattern = '/^\d+\.\d+?$/';
                if (preg_match($pattern, $amount)) {
                    try {
                        $bot->sendMessage('æŒ‡ä»¤æœ‰è¯¯ï¼Œè¯·è¾“å…¥æ•´æ•°', ['reply_to_message_id' => $bot->message()->message_id]);
                    } catch (\Exception $e) {
                        $bot->sendMessage('æŒ‡ä»¤æœ‰è¯¯ï¼Œè¯·è¾“å…¥æ•´æ•°');
                    }
                    return false;
                }
                if (preg_match($pattern, $num)) {
                    try {
                        $bot->sendMessage('æŒ‡ä»¤æœ‰è¯¯ï¼Œè¯·è¾“å…¥æ•´æ•°', ['reply_to_message_id' => $bot->message()->message_id]);
                    } catch (\Exception $e) {
                        $bot->sendMessage('æŒ‡ä»¤æœ‰è¯¯ï¼Œè¯·è¾“å…¥æ•´æ•°');
                    }
                    return false;
                }
                if ($num < 2 || $num > 100) {
                    try {
                        $bot->sendMessage('ç¦åˆ©çº¢åŒ…æ•°é‡ä¸èƒ½å°äº2ï¼Œå¤§äº100', ['reply_to_message_id' => $bot->message()->message_id]);
                    } catch (\Exception $e) {
                        $bot->sendMessage("ç¦åˆ©çº¢åŒ…æ•°é‡ä¸èƒ½å°äº2ï¼Œå¤§äº100");
                    }
                    return false;
                }
                if ($amount < 1) {
                    try {
                        $bot->sendMessage('ç¦åˆ©çº¢åŒ…é‡‘é¢å¿…é¡»å¤§äºç­‰äº1', ['reply_to_message_id' => $bot->message()->message_id]);
                    } catch (\Exception $e) {
                        $bot->sendMessage("ç¦åˆ©çº¢åŒ…é‡‘é¢å¿…é¡»å¤§äºç­‰äº1");
                    }
                    return false;
                }
                if ($amount / $num < 0.1) {
                    try {
                        $bot->sendMessage('ç¦åˆ©çº¢åŒ…æ•°é‡å¤ªå¤šï¼Œå‘é€å¤±è´¥ï¼', ['reply_to_message_id' => $bot->message()->message_id]);
                    } catch (\Exception $e) {
                        $bot->sendMessage("ç¦åˆ©çº¢åŒ…æ•°é‡å¤ªå¤šï¼Œå‘é€å¤±è´¥ï¼");
                    }
                    return false;
                }
                $num = (int)$num;
                $amount = (int)$amount;
                $sendUserId = $bot->user()->id;
                $senderInfo = TgUser::query()->where('tg_id', $sendUserId)->where('group_id', $bot->chat()->id)->first();
                //æ£€æŸ¥ä½™é¢
                $checkRs = TgUserService::checkBalance($senderInfo, $amount);
                if ($checkRs['state'] != 1) {
                    try {
                        $bot->sendMessage($checkRs['msg'], ['reply_to_message_id' => $bot->message()->message_id]);
                    } catch (\Exception $e) {
                        $bot->sendMessage($checkRs['msg']);
                    }
                } else {
                    try {
                        DB::beginTransaction();
                        //æ·»åŠ çº¢åŒ…
                        $luckyId = LuckyMoneyService::addLucky($senderInfo, $bot->message()->from->first_name, $amount, 0, $bot->chat()->id, $num, 0, 2);
                        if ($luckyId) {
                            $photo = get_photo($bot->chat()->id);
                            if (!$photo) {
                                DB::rollBack();
                                $bot->sendMessage('æœªè®¾ç½®å›¾ç‰‡ï¼è¯·è”ç³»ç®¡ç†å‘˜');
                                return false;
                            }
                            $InlineKeyboardMarkup = InlineKeyboardMarkup::make()->addRow(
                                InlineKeyboardButton::make("ğŸ§§ã€ç¦åˆ©çº¢åŒ…ã€‘å¿«æ¥æŠ¢[{$num}/0]æ€»{$amount}U ", callback_data: "qiang-" . $luckyId)
                            );
                            $data = [
                                'caption' => "[ <code>" . format_name($bot->message()->from->first_name) . "</code> ]å‘äº†ä¸ª {$amount} U ç¦åˆ©çº¢åŒ…ï¼Œå¿«æ¥æŠ¢ï¼",
                                'parse_mode' => ParseMode::HTML,
                                'reply_markup' => common_reply_markup($bot->chat()->id, $InlineKeyboardMarkup),
                                'reply_to_message_id' => $bot->message()->message_id
                            ];
                            $sendRs = $bot->sendPhoto($photo, $data);
                            if ($sendRs) {
                                $updateRs = LuckyMoney::query()->where('id', $luckyId)->update(['message_id' => $sendRs->message_id]);
                                if (!$updateRs) {
                                    DB::rollBack();
                                    $bot->sendMessage('å‘é€å¤±è´¥');
                                    return false;
                                }
                                DB::commit();
                            } else {
                                DB::rollBack();
                                $bot->sendMessage('å‘é€å¤±è´¥');
                            }
                        } else {
                            DB::rollBack();
                            $bot->sendMessage('å‘é€å¤±è´¥');
                        }
                    } catch (\Exception $e) {
                        DB::rollBack();
                        Log::error($e);
                    }
                }


            });

            $bot->onText('(1$|æŸ¥$|ä½™é¢$|ye$)', function (Nutgram $bot, $ac) {
                if ($ac == '1' || $ac == 'ye' || $ac == 'æŸ¥' || $ac == 'ä½™é¢' || $ac == 'æŸ¥ä½™é¢') {
                    $reply_to_message = $bot->message()->reply_to_message;
                    if (!$reply_to_message) {
                        $userInfo = TgUserService::getUserById($bot->user()->id, $bot->chat()->id);
                    }else{
                        $from = $bot->message()->from->id;
                        $finance = ConfigService::getConfigValue($bot->chat()->id, 'finance');
                        $financeArr = explode(',', $finance);
                        if (!in_array($from, $financeArr)) {
                            return false;
                        }
                        $userInfo = TgUserService::getUserById($reply_to_message->from->id, $bot->chat()->id);
                    }

                    $params = [];
                    if ($bot->message()->message_id) {
                        $params = ['parse_mode' => ParseMode::HTML, 'reply_to_message_id' => $bot->message()->message_id];
                    }
                    try {
                        try {
                            if (!$userInfo) {
                                $bot->sendMessage("ç”¨æˆ·æœªæ³¨å†Œ", $params);
                            } else {
                                $username = $userInfo->first_name?$userInfo->first_name:$userInfo->username;
                                $bot->sendMessage("ğŸ’°[ {$username} ] ä½™é¢ï¼š{$userInfo->balance}  U", $params);
                            }
                        } catch (\Exception $e) {
                            if (!$userInfo) {
                                $bot->sendMessage("ç”¨æˆ·æœªæ³¨å†Œ");
                            } else {
                                $username = $userInfo->first_name?$userInfo->first_name:$userInfo->username;
                                $bot->sendMessage("ğŸ’°[ {$username} ] ä½™é¢ï¼š{$userInfo->balance}  U");
                            }
                        }

                    } catch (\Exception $e) {
                        Log::error('æŸ¥è¯¢ä½™é¢å¼‚å¸¸' . $e);
                    }
                }
            });

            $bot->onCallbackQueryData('balance', function (Nutgram $bot) {
                $userInfo = TgUserService::getUserById($bot->user()->id, $bot->chat()->id);
                if (!$userInfo) {
                    $bot->answerCallbackQuery([
                        'text' => "ç”¨æˆ·æœªæ³¨å†Œ",
                        'show_alert' => true,
                        'cache_time' => 5
                    ]);

                } else {
                    $bot->answerCallbackQuery([
                        'text' => "{$userInfo->first_name} \n@{$userInfo->username} \n-----------------------------\nIDå·ï¼š{$userInfo->tg_id}\nä½™é¢ï¼š{$userInfo->balance}  U",
                        'parse_mode' => ParseMode::HTML,
                        'show_alert' => true,
                        'cache_time' => 5
                    ]);
                }

            });
            $bot->onCallbackQueryData('qiang-{luckyid}', function (Nutgram $bot, $luckyid) {
                $userId = $bot->user()->id;
                if (env('QUEUE_CONNECTION') == 'sync') {
                    self::qiangAction($bot, $luckyid, $userId, $bot->message()->message_id, $bot->callbackQuery()?->id);
                } else {
                    $jobData = [
                        'chat_id' => $bot->chat()->id,
                        'lucky_id' => $luckyid,
                        'user_id' => $userId,
                        'message_id' => $bot->message()->message_id,
                        'callback_query_id' => $bot->callbackQuery()?->id,
                    ];
                    MsgToTelegram::dispatch($jobData)->onQueue('qiang');
                }
//                Log::info('qiang=>' . json_encode($bot->message(), JSON_UNESCAPED_UNICODE));
                //

            });

            $bot->onCallbackQueryData('today_data', function (Nutgram $bot) {
                $result = TgUserService::getTodayData($bot->user()->id, $bot->chat()->id);
                $bot->answerCallbackQuery([
                    'text' => "ä»Šæ—¥ç›ˆåˆ©ï¼š{$result['todayProfit']}
-----------
å‘åŒ…æ”¯å‡ºï¼š-{$result['redPayTotal']}
å‘åŒ…ç›ˆæ”¶ï¼š+{$result['sendProfitTotal']}
-----------
æŠ¢åŒ…æ”¶å…¥ï¼š+{$result['getProfitTotal']}
æŠ¢åŒ…ä¸­é›·ï¼š-{$result['loseTotal']}
-----------
é‚€è¯·è¿”åˆ©ï¼š+{$result['todayInvite']}
ä¸‹çº§ä¸­é›·è¿”ç‚¹ï¼š+{$result['todayShare']}
",
                    'show_alert' => true,
                    'cache_time' => 10
                ]);
            });

            $bot->onCallbackQueryData('share_data', function (Nutgram $bot) {
                $result = TgUserService::getShareData($bot->user()->id, $bot->chat()->id);
                $listTxt = '';
                foreach ($result['inviteUserList'] as $val) {
                    $listTxt .= ($val['first_name'] != '' ? $val['first_name'] : $val['username']) . "\n";
                }
                $bot->answerCallbackQuery([
                    'text' => "ä»Šæ—¥é‚€è¯·ï¼š" . $result['todayCount'] . "
æœ¬æœˆé‚€è¯·ï¼š" . $result['monthCount'] . "
ç´¯è®¡é‚€è¯·ï¼š" . $result['totalCount'] . "
-----------
æ˜¾ç¤ºæœ€ååæ¡é‚€è¯·
-----------
" . $listTxt,
                    'show_alert' => true,
                    'cache_time' => 30
                ]);
            });

            /*$bot->onNewChatMembers(function (Nutgram $bot) {
                Log::info('onNewChatMembers==updateï¼š'.json_encode($bot->update()));
                $groupId = $bot->chat()->id;
                if(!$bot->message()){
                    return false;
                }
                $Member = $bot->message()->new_chat_members[0];
                if($Member){
                    $inviteTgId = !$bot->message()->from->is_bot ? $bot->message()->from->id : 0;
                    $rs = TgUserService::addUser($Member,$groupId,$inviteTgId);
                    if($rs['state'] == 1 ){
                        //æ¬¢è¿è¯­
                        $welcomeText = ConfigService::getConfigValue($groupId, 'welcome');
                        if($welcomeText){
                            $bot->sendMessage($welcomeText, ['parse_mode' => ParseMode::HTML]);
                        }
                    }
                }
            });*/


            $bot->onChatMember(function (Nutgram $bot) {
                $groupId = $bot->chat()->id;
                $status = $bot->chatMember()->new_chat_member->status;
                if ($status != 'member') {
                    return false;
                }
                $memberInfo = $bot->chatMember()->new_chat_member->user;
                if (!$memberInfo) {
                    return false;
                }
                $inviteTgId = 0;
                if (isset($bot->chatMember()->from) && $bot->chatMember()->from->id != $memberInfo->id) {
                    $inviteTgId = $bot->chatMember()->from->id;
                }
                if ($bot->chatMember()->invite_link) {
                    $inviteTgId = InviteLink::query()->where('invite_link', $bot->chatMember()->invite_link->invite_link)->value('tg_id');
                }

                $rs = TgUserService::addUser($memberInfo, $groupId, $inviteTgId);
                if ($rs['state'] == 1) {
                    //æ¬¢è¿è¯­
                    $welcomeText = ConfigService::getConfigValue($groupId, 'welcome');
                    if ($welcomeText) {
                        try {
                            $userName = $memberInfo->first_name?$memberInfo->first_name:$memberInfo->username;
                            $welcomeText = str_replace('{NAME}',$userName,$welcomeText);
                            $bot->sendMessage($welcomeText, ['parse_mode' => ParseMode::HTML]);
                        } catch (\Exception $e) {
                            Log::error('onChatMemberå¼‚å¸¸' . $e);
                        }

                    }
                }
                return true;
            });
//            $bot->onLeftChatMember(function (Nutgram $bot) {
//                $groupId = $bot->chat()->id;
//                $Member = $bot->message()->left_chat_member;
//                $Member->group_id = $groupId;
//                TgUserService::leftUser($Member);
//            });


            $bot->onCommand('register(.*)', function (Nutgram $bot) {
                $groupId = $bot->chat()->id;
                $Member = $bot->user();
                $rs = TgUserService::registerUser($Member, $groupId);

                try {
                    if ($rs['state'] == 1) {
                        $bot->sendMessage("æ³¨å†ŒæˆåŠŸ");
                    } else {
                        $bot->sendMessage($rs['msg']);
                    }
                } catch (\Exception $e) {
                    Log::error('registerå¼‚å¸¸' . $e);
                }

            });


            // Called on command "/help"
        });
    }

    public static function qiangAction($bot, $luckyid, $userId, $message_id, $callback_query_id = null)
    {
        $historyListKey = 'history_list_' . $luckyid;
        $historyListLen = Redis::llen($historyListKey);
        if ($historyListLen > 0) {
            for ($i = 0; $i < $historyListLen; $i++) {
                $json = Redis::lindex($historyListKey, $i);
                $historyObj = json_decode($json, true);
                if ($historyObj['user_id'] == $userId) {
                    if ($callback_query_id) {
                        try {
                            $bot->answerCallbackQuery([
                                'text' => 'æ‚¨å·²ç»é¢†å–è¯¥çº¢åŒ…ï¼Œé‡‘é¢ ' . $historyObj['amount'] . ' U',
                                'show_alert' => true,
                                'callback_query_id' => $callback_query_id,
                                'cache_time' => 60
                            ]);
                        } catch (\Exception $e) {
                            Log::error('å¼¹çª—æ¶ˆæ¯å¼‚å¸¸ã€æ‚¨å·²ç»é¢†å–è¯¥çº¢åŒ…ï¼Œé‡‘é¢ ' . $historyObj['amount'] . ' Uã€‘=>' . $e->getCode() . '  msg=>' . $e->getMessage() . ' line=>' . $e->getLine());
                        }

                    }
                    Log::info('æ‚¨å·²ç»é¢†å–è¯¥çº¢åŒ…ï¼Œé‡‘é¢ ' . $historyObj['amount'] . ' U');
                    return false;
                }
            }
        }

        $luckyKey = 'lucky_' . $luckyid;
        $luckyInfo = Redis::get('luckyInfo_' . $luckyid);
        if (!$luckyInfo) {
            $luckyInfo = LuckyMoney::query()->where('id', $luckyid)->first();
            if (!$luckyInfo) {
                if ($callback_query_id) {
                    $bot->answerCallbackQuery([
                        'text' => 'æ•°æ®ä¸å­˜åœ¨',
                        'show_alert' => true,
                        'callback_query_id' => $callback_query_id,
                        'cache_time' => 60
                    ]);
                }
                return false;
            }
            Redis::setex('luckyInfo_' . $luckyid, 5, serialize($luckyInfo->toArray()));
        } else {
            $luckyInfo = unserialize($luckyInfo);
        }


        $luckyNum = Redis::scard($luckyKey);
        if ($luckyNum == 0) {
            if ($callback_query_id) {
                try {
                    $bot->answerCallbackQuery([
                        'text' => 'è¯¥çº¢åŒ…å·²å…¨éƒ¨è¢«é¢†å–',
                        'show_alert' => true,
                        'callback_query_id' => $callback_query_id,
                        'cache_time' => 60
                    ]);
                } catch (\Exception $e) {
                    Log::error('å¼¹çª—æ¶ˆæ¯å¼‚å¸¸ã€è¯¥çº¢åŒ…å·²å…¨éƒ¨è¢«é¢†å–ã€‘=>' . $e->getCode() . '  msg=>' . $e->getMessage() . ' line=>' . $e->getLine());
                }
            }
            Log::info('è¯¥çº¢åŒ…å·²å…¨éƒ¨è¢«é¢†å–');
            return false;
        }

        $userInfo = Redis::get('userInfo_' . $userId . '_' . $luckyInfo['chat_id']);
        if (!$userInfo) {
            $userInfo = TgUser::query()->where('tg_id', $userId)->where('group_id', $luckyInfo['chat_id'])->first();
            if($userInfo){
                Redis::setex('userInfo_' . $userId . '_' . $luckyInfo['chat_id'], 5, serialize($userInfo->toArray()));
            }
        } else {
            $userInfo = unserialize($userInfo);
        }
        $checkRs = LuckyMoneyService::checkLuck($luckyInfo, $userInfo);
        if (!$checkRs['state']) {
            if ($callback_query_id) {
                try {
                    $bot->answerCallbackQuery([
                        'text' => $checkRs['msg'],
                        'show_alert' => true,
                        'callback_query_id' => $callback_query_id,
                    ]);
                } catch (\Exception $e) {
                    Log::error('å¼¹çª—æ¶ˆæ¯å¼‚å¸¸ã€' . $checkRs['msg'] . 'ã€‘=>' . $e->getCode() . '  msg=>' . $e->getMessage() . ' line=>' . $e->getLine());
                }

            }
            Log::info('checkLuck=>' . $checkRs['msg']);
            return false;
        }
        if ($userInfo['pass_mine'] == 1) {
            $smembers = Redis::smembers($luckyKey);
            $redAmount = 0;
            foreach ($smembers as $sval) {
                $sval = number_format($sval, 2, '.', '');
                $isThunder = LuckyMoneyService::checkThunder($sval, $luckyInfo['thunder']);
                if (!$isThunder) {
                    $redAmount = $sval;
                    break;
                }
            }
            if ($redAmount > 0) {
                Redis::srem($luckyKey, $redAmount);
            } else {
                $redAmount = Redis::spop($luckyKey);
            }
        } else if ($userInfo['get_mine'] == 1) {
            $smembers = Redis::smembers($luckyKey);
            $redAmount = 0;
            foreach ($smembers as $sval) {
                $sval = number_format($sval, 2, '.', '');
                $isThunder = LuckyMoneyService::checkThunder($sval, $luckyInfo['thunder']);
                if ($isThunder) {
                    $redAmount = $sval;
                    break;
                }
            }
            if ($redAmount > 0) {
                Redis::srem($luckyKey, $redAmount);
            } else {
                $redAmount = Redis::spop($luckyKey);
            }
        } else {
            $redAmount = Redis::spop($luckyKey);
        }
        if (!$redAmount) {
            if ($callback_query_id) {
                try {
                    $bot->answerCallbackQuery([
                        'text' => 'è¯¥çº¢åŒ…å·²å…¨éƒ¨è¢«é¢†å–',
                        'show_alert' => true,
                        'callback_query_id' => $callback_query_id,
                        'cache_time' => 60
                    ]);
                } catch (\Exception $e) {
                    Log::error('å¼¹çª—æ¶ˆæ¯å¼‚å¸¸ã€è¯¥çº¢åŒ…å·²å…¨éƒ¨è¢«é¢†å–1ã€‘=>' . $e->getCode() . '  msg=>' . $e->getMessage() . ' line=>' . $e->getLine());
                }
            }
            Log::info('è¯¥çº¢åŒ…å·²å…¨éƒ¨è¢«é¢†å–:redAmount=' . $redAmount);
            return false;
        }

        $redAmount = number_format($redAmount, 2, '.', '');
        $isThunder = LuckyMoneyService::checkThunder($redAmount, $luckyInfo['thunder']);

        $loseMoney = 0;
        if ($isThunder) {
            $loseRate = ConfigService::getConfigValue($luckyInfo['chat_id'], 'lose_rate');
            $loseRate = $loseRate > 0 ? $loseRate : 1.8;
            $loseMoney = round($luckyInfo['amount'] * $loseRate, 2);
            $answerText = "ä¸­é›·ï¼Œé¢†å– {$redAmount} Uï¼ŒæŸå¤± {$loseMoney} U";
        } else {
            if ($luckyInfo['type'] == 1) {
                $answerText = "ğŸ’µæ‚¨æŠ¢åˆ° {$redAmount} U çš„çº¢åŒ…";
            } else {
                $answerText = "æ­å–œï¼ŒæŠ¢åˆ°ç¦åˆ©çº¢åŒ… {$redAmount} U";
            }
        }

        if ($callback_query_id) {
            try {
                $bot->answerCallbackQuery([
                    'text' => $answerText,
                    'show_alert' => true,
                    'callback_query_id' => $callback_query_id,
                ]);
                self::editMsg($bot, $userInfo, $luckyInfo, $isThunder, $redAmount, $loseMoney, $message_id);
            } catch (\Exception $e) {
                Redis::sadd($luckyKey, $redAmount);
                Log::error('å¼¹çª—æ¶ˆæ¯å¼‚å¸¸ã€' . $answerText . 'ã€‘=>' . $e->getCode() . '  msg=>' . $e->getMessage() . ' line=>' . $e->getLine());
            }
        } else {
            self::editMsg($bot, $userInfo, $luckyInfo, $isThunder, $redAmount, $loseMoney, $message_id);
        }

//        usleep(500000);
        return true;
    }

    public static function editMsg($bot, $userInfo, $luckyInfo, $isThunder, $redAmount, $loseMoney, $message_id)
    {
        $luckyid = $luckyInfo['id'];
        $luckyKey = 'lucky_' . $luckyid;
        $userId = $userInfo['tg_id'];
        $userName = $userInfo['first_name'] != null ? $userInfo['first_name'] : $userInfo['username'];
        $historyVal = [
            'user_id' => $userId,
            'first_name' => $userName,
            'lucky_id' => $luckyid,
            'is_thunder' => $isThunder,
            'amount' => $redAmount,
            'lose_money' => $loseMoney,
        ];
        $historyListKey = 'history_list_' . $luckyid;
        Redis::rpush($historyListKey, json_encode($historyVal));
        $luckyAmount = (int)$luckyInfo['amount'];
        $openNum = Redis::llen($historyListKey);
        Log::info($luckyid.'æ‰“å¼€æ•°é‡=> ' . $openNum);
        if ($luckyInfo['number'] > $openNum) {
            $titleText = 'ç¦åˆ©çº¢åŒ…';
            $thunderText = '';
            $qiangText = 'ğŸ§§ã€ç¦åˆ©çº¢åŒ…ã€‘å¿«æ¥æŠ¢';
            if ($luckyInfo['type'] == 1) {
                $thunderText = "ğŸ’¥é›·{$luckyInfo['thunder']}";
                $qiangText = "ğŸ§§æŠ¢çº¢åŒ…";
                $titleText = "çº¢åŒ…";
            }

            $InlineKeyboardMarkup = InlineKeyboardMarkup::make()->addRow(
                InlineKeyboardButton::make("{$qiangText}[{$luckyInfo['number']}/{$openNum}] æ€»{$luckyAmount}U {$thunderText}", callback_data: "qiang-" . $luckyid)
            );
            $data = [
                'message_id' => $message_id,
                'caption' => "[ <code>" . format_name($luckyInfo['sender_name']) . "</code> ]å‘äº†ä¸ª {$luckyAmount} U {$titleText}ï¼Œå¿«æ¥æŠ¢ï¼",
                'parse_mode' => ParseMode::HTML,
                'reply_markup' => common_reply_markup($luckyInfo['chat_id'], $InlineKeyboardMarkup),
                'chat_id' => $luckyInfo['chat_id']
            ];
            try {
                $bot->editMessageCaption($data);
            } catch (\Exception $e) {
                Log::error('æŠ¢åŒ…ä¿®æ”¹æ¶ˆæ¯å¼‚å¸¸=>' . $e->getCode() . '  msg=>' . $e->getMessage() . ' line=>' . $e->getLine());
//                Redis::lpush($luckyKey, $redAmount);
//                Redis::rpop($historyListKey);
            }
            self::doAddHistory($bot, $luckyid, $userId, $redAmount, $isThunder, $loseMoney);
        } else {
            $details = '';
            $loseMoneyTotal = 0;
            $thunderCount = 0;
            $rewardCount = 0;
            for ($j = 1; $j <= $openNum; $j++) {
                $valJson = Redis::lindex($historyListKey, $j - 1);
                $val = json_decode($valJson, true);
                if ($val['is_thunder'] != 1) {
                    $thunderCount++;
                    $details .= $j . ".[ğŸ’µ] <code>" . number_format(round($val['amount'], 2), 2, '.', '') . "</code> U <code>" . format_name($val['first_name']) . "</code>\n";
                } else {
                    $details .= $j . ".[ğŸ’£] <code>" . number_format(round($val['amount'], 2), 2, '.', '') . "</code> U <code>" . format_name($val['first_name']) . "</code>\n";
                    $loseMoneyTotal += $val['lose_money'];
                }
                if ($luckyInfo['type'] == 1 && isset($redAmount) && leopard_check($redAmount)) {
                    $rewardCount++;
                }elseif ($luckyInfo['type'] == 1 && isset($redAmount) && straight_check($redAmount)) {
                    $rewardCount++;
                }
            }


            $profit = $loseMoneyTotal - $luckyInfo['amount'];
            $profitTxt = $profit >= 0 ? '+' . $profit : $profit;

            if ($luckyInfo['type'] == 1) {
                $caption = "[ <code>" . format_name($luckyInfo['sender_name']) . "</code> ]çš„çº¢åŒ…å·²è¢«é¢†å®Œï¼\n
ğŸ§§çº¢åŒ…é‡‘é¢ï¼š" . $luckyAmount . " U
ğŸ›çº¢åŒ…å€æ•°ï¼š" . round($luckyInfo['lose_rate'], 2) . "
ğŸ’¥ä¸­é›·æ•°å­—ï¼š{$luckyInfo['thunder']}\n
--------é¢†å–è¯¦æƒ…--------\n
" . $details . "
<pre>ğŸ’¹ ä¸­é›·ç›ˆåˆ©ï¼š " . round($loseMoneyTotal, 2) . "</pre>
<pre>ğŸ’¹ å‘åŒ…æˆæœ¬ï¼š-" . $luckyAmount . "</pre>
<pre>ğŸ’¹ åŒ…ä¸»å®æ”¶ï¼š{$profitTxt}</pre>";
            } else {
                $caption = "[ <code>" . format_name($luckyInfo['sender_name']) . "</code> ]çš„ç¦åˆ©çº¢åŒ…å·²è¢«é¢†å®Œï¼\n
ğŸ§§çº¢åŒ…é‡‘é¢ï¼š" . $luckyInfo['amount'] . " U
\n
--------é¢†å–è¯¦æƒ…--------\n
" . $details . "
<pre>ğŸ’¹ å‘åŒ…æˆæœ¬ï¼š-" . $luckyAmount . "</pre>
";
            }
            $data = [
                'message_id' => $message_id,
                'caption' => $caption,
                'parse_mode' => ParseMode::HTML,
                'reply_markup' => common_reply_markup($luckyInfo['chat_id']),
                'chat_id' => $luckyInfo['chat_id']
            ];
            $num = 3;
            for ($i = $num; $i >= 0; $i--) {
                if ($i <= 0) {
                    Log::error('é‡è¯•3æ¬¡ï¼ŒæŠ¢åŒ…å®Œæˆä¿®æ”¹å¤±è´¥');
                    return false;
                }
                try {
                    $bot->editMessageCaption($data);
                    Redis::del($historyListKey);
                    self::doAddHistory($bot, $luckyid, $userId, $redAmount, $isThunder, $loseMoney);
                    if($rewardCount>=3){
                        //è§¦å‘jackpot
                        self::jackpotReward($bot,$luckyInfo);
                    }
                    break;
                } catch (\Exception $e) {
                    Log::error('æŠ¢åŒ…å®Œæˆä¿®æ”¹æ¶ˆæ¯å¼‚å¸¸=>' . $e->getCode() . '  msg=>' . $e->getMessage() . ' line=>' . $e->getLine());
                    if ($e->getCode() == 429) {
                        $retry_after = $e->getParameter('retry_after');
                        sleep($retry_after);
                    } else {
                        Redis::sadd($luckyKey, $redAmount);
                        Redis::rpop($historyListKey);
                        break;
                    }
                }
            }


        }
        return true;

    }
    public static function doAddHistory($bot, $luckyid, $userId, $redAmount, $isThunder, $loseMoney){
        if (env('QUEUE_CONNECTION') == 'sync') {
            self::addHistory($bot, $luckyid, $userId, $redAmount, $isThunder, $loseMoney);
        } else {
            $historyData = [
                'luckyid' => $luckyid,
                'userId' => $userId,
                'loseMoney' => $loseMoney,
                'isThunder' => $isThunder,
                'redAmount' => $redAmount,
            ];
            LuckyHistoryJob::dispatch($historyData)->onQueue('history');
        }
    }

    public static function addHistory($bot, $luckyid, $userId, $redAmount, $isThunder, $loseMoney)
    {
        DB::beginTransaction();
        $luckyInfo = LuckyMoney::query()->where('id', $luckyid)->first();
        if ($luckyInfo['status'] != 1) {
            Log::error('addHistoryçº¢åŒ…å·²é¢†å®Œæˆ–è€…å·²è¿‡æœŸ');
            DB::rollBack();
            return false;
        }

        $userInfo = TgUser::query()->where('tg_id', $userId)->where('group_id', $luckyInfo['chat_id'])->first();
        $userName = $userInfo['first_name'] != null ? $userInfo['first_name'] : $userInfo['username'];

        $openNum = LuckyHistory::query()->where('lucky_id', $luckyid)->count();
        $historyRs = LuckyMoneyService::addLuckyHistory($userInfo['tg_id'], $userName, $luckyInfo['id'], $isThunder, $redAmount, $loseMoney);
        if ($historyRs) {
            if ($luckyInfo['number'] <= $openNum + 1) {
                $luckyInfo->status = 2;
            }
            $luckyInfo->received = round($luckyInfo['received'] + (float)$redAmount, 2);
            $luckyInfo->received_num = $luckyInfo['received_num'] + 1;
            $rsR = $luckyInfo->save();
            if (!$rsR) {
                Log::error('save æ›´æ–°å¤±è´¥');
                DB::rollBack();
                return false;
            }
            DB::commit();
        } else {
            Log::error('addLuckyHistory é¢†å–å¤±è´¥');
            DB::rollBack();
            return false;
        }
        LuckyMoneyService::loseMoneyCal($userId, $luckyInfo, $loseMoney);
        LuckyMoneyService::getCal($userId, $luckyInfo, $redAmount);
        //åˆ¤æ–­æ˜¯å¦æ˜¯è±¹å­
        if ($luckyInfo['type'] == 1 && isset($redAmount) && leopard_check($redAmount)) {
            $amountCount = amount_count($redAmount);
            switch ($amountCount) {
                case 4:
                    $leopardReward = ConfigService::getConfigValue($luckyInfo['chat_id'], 'leopard_reward_4');
                    break;
                case 5:
                    $leopardReward = ConfigService::getConfigValue($luckyInfo['chat_id'], 'leopard_reward_5');
                    break;
                case 3:
                default:
                    $leopardReward = ConfigService::getConfigValue($luckyInfo['chat_id'], 'leopard_reward');
                    break;
            }
            if ($leopardReward > 0) {
                $bot->sendMessage("ğŸ‰ğŸ‰[  {$userName}  ] æŠ¢åˆ°è±¹å­{$redAmount} å¥–åŠ±:{$leopardReward} å·²åˆ°è´¦.", ['chat_id' => $luckyInfo['chat_id'], 'parse_mode' => ParseMode::HTML]);
                LuckyMoneyService::addRewardRecord($luckyid, $luckyInfo['sender_id'], $userId, $luckyInfo['chat_id'], $leopardReward, $redAmount, 1);
            }
        }
        //åˆ¤æ–­æ˜¯å¦æ˜¯é¡ºå­
        if ($luckyInfo['type'] == 1 && isset($redAmount) && straight_check($redAmount)) {
            $amountCount = amount_count($redAmount);
            switch ($amountCount) {
                case 4:
                    $straightReward = ConfigService::getConfigValue($luckyInfo['chat_id'], 'straight_reward_4');
                    break;
                case 5:
                    $straightReward = ConfigService::getConfigValue($luckyInfo['chat_id'], 'straight_reward_5');
                    break;
                case 3:
                default:
                    $straightReward = ConfigService::getConfigValue($luckyInfo['chat_id'], 'straight_reward');
                    break;
            }
            if ($straightReward > 0) {
                $bot->sendMessage("ğŸ‰ğŸ‰[  {$userName}  ] æŠ¢åˆ°é¡ºå­{$redAmount} å¥–åŠ±:{$straightReward} å·²åˆ°è´¦.", ['chat_id' => $luckyInfo['chat_id'], 'parse_mode' => ParseMode::HTML]);
                LuckyMoneyService::addRewardRecord($luckyid, $luckyInfo['sender_id'], $userId, $luckyInfo['chat_id'], $straightReward, $redAmount, 2);
            }
        }
        return true;
    }
    //å¥–æ± åˆ†é…
    public static function jackpotReward($bot, $luckyInfo)
    {
        $jackpotCommission = ConfigService::getConfigValue($luckyInfo['chat_id'], 'jackpot');
        if($jackpotCommission>0){
            $jackInfo = JackpotPool::query()->where('group_id',$luckyInfo['chat_id'])->first();
            if($jackInfo['balance'] > 0){

                $ls = LuckyHistory::query()->where('lucky_id',$luckyInfo['id'])->get();
                $userIds = array_column($ls->toArray(),'user_id');
                $rewardAmount = $jackInfo['balance'] * 0.4;
                $text = "ğŸŒŸæ­å–œï¼ä¸­å¤§å¥–äº†ğŸŒŸ\nä¸­å¥–é‡‘é¢ï¼š<b>{$rewardAmount}</b>\n";
                $text .= "æ­å–œä»¥ä¸‹ä¸­å¥–ç”¨æˆ·ï¼š\n\n";
                //å¥–æ± å‡å°‘
                JackpotPool::query()->where('group_id',$luckyInfo['chat_id'])->decrement('balance',$rewardAmount);
                $senderAmount = round($rewardAmount/2,2);

                $user = TgUser::query()->where('tg_id',$luckyInfo['sender_id'])->first();
                $user->balance = $user->balance + $senderAmount;
                $user->save();
                $userName = $user['first_name']?$user['first_name']:$user['username'];
                $text .= "ğŸ’µ{$senderAmount} <code>{$userName}</code>\n";
                //è®°å½•
                JackpotReward::query()->create([
                    'lucky_id'=>$luckyInfo['id'],
                    'amount'=>$senderAmount,
                    'tg_id'=>$luckyInfo['sender_id'],
                    'group_id'=>$luckyInfo['chat_id'],
                    'sender_id'=>$luckyInfo['sender_id']
                ]);
                money_log($luckyInfo['chat_id'],$luckyInfo['sender_id'],$senderAmount,'jacpotprofit','jackpotå‘åŒ…ä¸­å¥–',$luckyInfo['id']);

                $averageAmount = round($senderAmount/count($userIds),2);

                //æ¯ä¸ªç”¨æˆ·å¥–åŠ±
                foreach ($userIds as $userId){
                    $user = TgUser::query()->where('tg_id',$userId)->first();
                    $user->balance = $user->balance + $averageAmount;
                    $user->save();
                    $userName = $user['first_name']?$user['first_name']:$user['username'];
                    $text .= "ğŸ’µ{$averageAmount} <code>{$userName}</code>\n";
                    //è®°å½•
                    JackpotReward::query()->create([
                        'lucky_id'=>$luckyInfo['id'],
                        'amount'=>$averageAmount,
                        'tg_id'=>$userId,
                        'group_id'=>$luckyInfo['chat_id'],
                        'sender_id'=>$luckyInfo['sender_id']
                    ]);
                    money_log($luckyInfo['chat_id'],$luckyInfo['sender_id'],$averageAmount,'jacpotprofit','jackpotä¸­å¥–',$luckyInfo['id']);
                }
                $text .= "\nå¥–é‡‘å·²è‡ªåŠ¨å‘æ”¾åˆ°è´¦æˆ·ï¼Œè¯·æŸ¥æ”¶~\n";

                $bot->sendMessage($text, ['chat_id' => $luckyInfo['chat_id'], 'parse_mode' => ParseMode::HTML]);
            }
        }
    }




}
